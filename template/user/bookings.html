{% extends 'user/base.html' %}
{% load static %}

{% block title %}My Bookings{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1">
                <i class="bi bi-journal-check me-2 text-primary"></i>My Bookings
            </h4>
            <p class="text-muted small mb-0">View and manage your vendor bookings</p>
        </div>
        <a href="{% url 'user:stores_list' %}" class="btn btn-primary btn-sm">
            <i class="bi bi-shop me-1"></i> Browse Stores
        </a>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Filter -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body py-3">
            <form method="get" class="d-flex gap-2 align-items-center flex-wrap">
                <label class="text-muted small me-2">Filter:</label>
                <select name="status" class="form-select form-select-sm" style="width: 150px;">
                    <option value="">All</option>
                    <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="confirmed" {% if status_filter == 'confirmed' %}selected{% endif %}>Confirmed</option>
                    <option value="in_progress" {% if status_filter == 'in_progress' %}selected{% endif %}>In Progress</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="cancelled" {% if status_filter == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
                <button type="submit" class="btn btn-outline-primary btn-sm">
                    <i class="bi bi-funnel me-1"></i>Apply
                </button>
                {% if status_filter %}
                <a href="{% url 'user:user_bookings' %}" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-x-circle me-1"></i>Clear
                </a>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Bookings List -->
    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            {% if bookings %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4">Store / Vendor</th>
                            <th>Event</th>
                            <th>Service</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Booked On</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for booking in bookings %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-semibold">
                                    <a href="{% url 'user:store_detail' booking.store.id %}" class="text-decoration-none">
                                        {{ booking.store.store_name }}
                                    </a>
                                </div>
                                <small class="text-muted">{{ booking.vendor.fullname }}</small>
                            </td>
                            <td>{{ booking.event.title }}</td>
                            <td>{% if booking.service %}{{ booking.service.name }}{% else %}—{% endif %}</td>
                            <td><span class="fw-semibold">₹{{ booking.amount }}</span></td>
                            <td>
                                {% if booking.status == 'pending' %}
                                <span class="badge bg-warning bg-opacity-10 text-warning px-3 py-2">
                                    <i class="bi bi-clock me-1"></i>Pending
                                </span>
                                {% elif booking.status == 'confirmed' %}
                                <span class="badge bg-success bg-opacity-10 text-success px-3 py-2">
                                    <i class="bi bi-check-circle me-1"></i>Confirmed
                                </span>
                                {% elif booking.status == 'in_progress' %}
                                <span class="badge bg-info bg-opacity-10 text-info px-3 py-2">
                                    <i class="bi bi-gear me-1"></i>In Progress
                                </span>
                                {% elif booking.status == 'completed' %}
                                <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                                    <i class="bi bi-star me-1"></i>Completed
                                </span>
                                {% elif booking.status == 'cancelled' %}
                                <span class="badge bg-danger bg-opacity-10 text-danger px-3 py-2">
                                    <i class="bi bi-x-circle me-1"></i>Cancelled
                                </span>
                                {% else %}
                                <span class="badge bg-secondary bg-opacity-10 text-secondary px-3 py-2">
                                    {{ booking.status }}
                                </span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="d-block">Advance: ₹{{ booking.advance_paid|default:0 }} / ₹{{ booking.advance_required|default:0 }}</small>
                                    {% if booking.latest_payment %}
                                        {% if booking.latest_payment.status == 'succeeded' %}
                                            <span class="badge bg-success">Paid</span>
                                        {% elif booking.latest_payment.status == 'pending' %}
                                            <span class="badge bg-warning">Payment Pending</span>
                                        {% else %}
                                            <span class="badge bg-danger">Last payment failed</span>
                                        {% endif %}
                                    {% else %}
                                        <small class="text-muted">No payments</small>
                                    {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    <i class="bi bi-calendar me-1"></i>{{ booking.created_at|date:"M d, Y" }}
                                    <br><i class="bi bi-clock me-1"></i>{{ booking.created_at|date:"h:i A" }}
                                </small>
                            </td>
                            <td class="text-end pe-4">
                                <div class="d-flex gap-1 justify-content-end">
                                    <!-- Removed booking_detail link that was causing error -->
                                    
                                    {% if booking.status == 'pending' %}
                                    <form method="post" action="{% url 'user:user_bookings' %}" class="d-inline" onsubmit="return confirm('Are you sure you want to cancel this booking?');">
                                        {% csrf_token %}
                                        <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                        <input type="hidden" name="action" value="cancel">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Cancel Booking">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </form>
                                    {% endif %}
                                    {% comment %} Pay button: show when advance_due > 0 and booking pending {% endcomment %}
                                    {% if booking.status == 'pending' and booking.advance_required|default:0 > booking.advance_paid|default:0 %}
                                    <a href="{% url 'user:pay_booking' booking.id %}" class="btn btn-sm btn-outline-primary" title="Pay Advance">
                                        <i class="bi bi-currency-exchange"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if booking.status == 'confirmed' or booking.status == 'in_progress' or booking.status == 'completed' %}
                                    <a href="{% url 'user:start_chat' booking.store.id %}" class="btn btn-sm btn-outline-success" title="Chat with Vendor">
                                        <i class="bi bi-chat"></i>
                                    </a>
                                    {% else %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" title="Chat available after approval" disabled>
                                        <i class="bi bi-chat"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="empty-state">
                    <i class="bi bi-journal-x display-1 text-muted mb-3"></i>
                    <h5 class="text-muted">No Bookings Found</h5>
                    <p class="text-muted small mb-3">You haven't made any bookings yet.</p>
                    <a href="{% url 'user:stores_list' %}" class="btn btn-primary">
                        <i class="bi bi-shop me-2"></i>Browse Stores
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<style>
    .card {
        border-radius: 12px;
        overflow: hidden;
    }
    
    .table thead th {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: #64748b;
        border-bottom-width: 1px;
    }
    
    .table td {
        vertical-align: middle;
        padding: 1rem 0.5rem;
    }
    
    .badge {
        font-weight: 500;
        border-radius: 20px;
    }
    
    .btn-sm {
        padding: 0.4rem 0.6rem;
    }
    
    .empty-state {
        padding: 3rem;
    }
    
    /* Hover effect */
    tbody tr:hover {
        background-color: #f8fafc;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .table td {
            padding: 0.75rem 0.5rem;
        }
        
        .d-flex.gap-1 {
            flex-direction: column;
        }
    }
</style>
{% endblock %}