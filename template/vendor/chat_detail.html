{% extends 'vendor/base.html' %}
{% block title %}Chat - {{ chat.user.fullname }}{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h4 class="mb-0">{{ chat.user.fullname }}</h4>
      <small class="text-muted">{% if chat.store %}Regarding: {{ chat.store.store_name }}{% endif %}</small>
    </div>
    <div>
      <a href="{% url 'vendor_chat' %}" class="btn btn-outline-secondary me-2">Back</a>
      <form method="post" action="{% url 'vendor_delete_chat' chat.id %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-outline-danger">Delete Conversation</button>
      </form>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-3" style="height:65vh; overflow:auto; background:#f8f9fa;">
      <div id="messagesContainer">
        {% for message in messages %}
        <div class="d-flex mb-3 {% if message.sender.id == vendor.id %}justify-content-end{% else %}justify-content-start{% endif %}" data-message-id="{{ message.id }}">
          <div class="p-2 rounded" style="max-width:75%; background:{% if message.sender.id == vendor.id %}#0d6efd;color:#fff;{% else %}#fff;border:1px solid #e9ecef;{% endif %}">
            <div class="small mb-1 text-muted">{{ message.sender.fullname }} Â· <span class="text-muted">{{ message.created_at|date:"g:i A" }}</span></div>
            {% if message.image %}
            <div class="mb-2">
              <a href="{{ message.image.url }}" target="_blank"><img src="{{ message.image.url }}" alt="attachment" style="max-width:320px; max-height:320px; border-radius:8px; display:block;"></a>
            </div>
            {% endif %}
            <div>{{ message.message }}</div>
          </div>
          {% if message.sender.id == vendor.id %}
          <button type="button" class="btn btn-sm btn-light ms-2 delete-message-btn" data-url="{% url 'vendor_delete_message' message.id %}" data-msgid="{{ message.id }}" title="Delete message">
            <i class="bi bi-trash"></i>
          </button>
          {% endif %}
        </div>
        {% empty %}
        <div class="text-center text-muted py-5">No messages yet. Say hello!</div>
        {% endfor %}
      </div>
    </div>

    <div class="card-footer">
      <form method="post" enctype="multipart/form-data" id="sendMessageForm">
        {% csrf_token %}
        <div class="d-flex align-items-center gap-2">
          <div id="imagePreviewContainer" style="display:none; align-items:center;">
            <img id="imagePreview" src="" alt="preview" style="max-width:110px; max-height:110px; border-radius:8px; object-fit:cover;">
            <button type="button" id="removeImageBtn" class="btn btn-sm btn-outline-secondary ms-2">Remove</button>
          </div>
          <input type="text" name="message" id="messageInput" class="form-control" placeholder="Type a message...">
          <label class="btn btn-outline-secondary mb-0">
            <i class="bi bi-image"></i>
            <input type="file" name="image" id="fileInput" accept="image/*" style="display:none">
          </label>
          <button type="submit" class="btn btn-primary">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete modal -->
<div class="modal fade" id="deleteMessageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body">
        <p>Are you sure you want to delete this message?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteMessageForm" method="post" style="display:inline;">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function getCookie(name) { const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return v ? v.pop() : ''; }
document.addEventListener('DOMContentLoaded', function(){
  // Auto-scroll
  const messagesContainer = document.getElementById('messagesContainer');
  if (messagesContainer) messagesContainer.parentElement.scrollTop = messagesContainer.parentElement.scrollHeight;

  // Image preview
  const fileInput = document.getElementById('fileInput');
  const previewContainer = document.getElementById('imagePreviewContainer');
  const previewImg = document.getElementById('imagePreview');
  const removeBtn = document.getElementById('removeImageBtn');
  let objectUrl = null;
  if (fileInput) {
    fileInput.addEventListener('change', function(){
      const file = fileInput.files && fileInput.files[0];
      if (!file || !file.type.startsWith('image/')) { previewImg.src=''; previewContainer.style.display='none'; return; }
      if (objectUrl) URL.revokeObjectURL(objectUrl);
      objectUrl = URL.createObjectURL(file);
      previewImg.src = objectUrl; previewContainer.style.display='flex';
    });
  }
  if (removeBtn) removeBtn.addEventListener('click', function(){ fileInput.value=''; if (objectUrl) { URL.revokeObjectURL(objectUrl); objectUrl=null;} previewImg.src=''; previewContainer.style.display='none'; });

  // Delete message via modal + fetch
  const deleteButtons = document.querySelectorAll('.delete-message-btn');
  const modalEl = document.getElementById('deleteMessageModal');
  const deleteForm = document.getElementById('deleteMessageForm');
  let bsModal = modalEl ? new bootstrap.Modal(modalEl) : null;
  let selectedMsgId = null;
  deleteButtons.forEach(btn => btn.addEventListener('click', function(e){ e.preventDefault(); selectedMsgId = btn.getAttribute('data-msgid'); if (deleteForm) deleteForm.action = btn.getAttribute('data-url'); if (bsModal) bsModal.show(); }));
  if (deleteForm) {
    deleteForm.addEventListener('submit', function(ev){ ev.preventDefault(); const action = deleteForm.action; if (!action) return; fetch(action, { method:'POST', headers:{ 'X-Requested-With':'XMLHttpRequest', 'X-CSRFToken': getCookie('csrftoken'), 'Accept':'application/json' }, credentials:'same-origin' }).then(r=>{ if(!r.ok) throw new Error('Network'); return r.json(); }).then(data=>{ if (data && data.deleted) { if (bsModal) bsModal.hide(); const el = document.querySelector('[data-message-id="'+selectedMsgId+'"]'); if (el) el.remove(); } else { throw new Error('Delete failed'); } }).catch(()=>{ alert('Could not delete message'); }); });
  }
});
</script>
{% endblock %}
