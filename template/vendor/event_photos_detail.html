{% extends "vendor/base.html" %}
{% block title %}{{ event.title }} — Photos{% endblock %}

{% block content %}

<!-- Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <a href="{% url 'upload_event_image' %}" class="text-muted text-decoration-none small mb-1 d-inline-block">
            <i class="bi bi-arrow-left me-1"></i> Back to Events
        </a>
        <h3 class="mb-0">{{ event.title }}</h3>
        <p class="text-muted mb-0 small">
            <i class="bi bi-calendar me-1"></i>{{ event.date|date:"F d, Y" }}
            &nbsp;|&nbsp;
            <i class="bi bi-person me-1"></i>{{ event.owner.fullname }}
            &nbsp;|&nbsp;
            <span class="badge bg-{% if event.status == 'pending' %}warning{% elif event.status == 'confirmed' %}success{% elif event.status == 'completed' %}primary{% else %}secondary{% endif %}">
                {{ event.get_status_display }}
            </span>
        </p>
    </div>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="bi bi-cloud-upload me-2"></i> Upload Photos
    </button>
</div>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <i class="bi bi-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
{% endif %}

<!-- Photos Grid -->
{% if photos %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <span class="text-muted small">
        <i class="bi bi-images me-1"></i>{{ photos|length }} photo{{ photos|length|pluralize }}
    </span>
</div>
<div class="row g-3">
    {% for photo in photos %}
    <div class="col-md-3 col-sm-4 col-6">
        <div class="position-relative photo-card">
            <img src="{{ photo.image.url }}"
                 alt="{{ event.title }}"
                 class="img-fluid rounded shadow-sm w-100"
                 style="height: 200px; object-fit: cover; cursor: pointer;"
                 data-bs-toggle="modal"
                 data-bs-target="#photoModal"
                 data-src="{{ photo.image.url }}"
                 data-caption="{{ event.title }} — {{ photo.uploaded_at|date:'d M Y, g:i A' }}">
            <!-- Delete button -->
            <form method="POST" style="display:inline;"
                  onsubmit="return confirm('Delete this photo?')">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="image_id" value="{{ photo.id }}">
                <button type="submit"
                        class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 delete-btn"
                        title="Delete photo">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
            <!-- Upload date -->
            <div class="position-absolute bottom-0 start-0 end-0 px-2 py-1 photo-date-overlay rounded-bottom">
                <small class="text-white">{{ photo.uploaded_at|date:"d M Y" }}</small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card-box text-center py-5">
    <i class="bi bi-camera fs-1 text-muted mb-3"></i>
    <h5 class="text-muted">No photos uploaded yet</h5>
    <p class="text-muted">Upload photos you captured for this event.</p>
    <button class="btn btn-success mt-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
        <i class="bi bi-cloud-upload me-2"></i> Upload First Photo
    </button>
</div>
{% endif %}

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-camera me-2"></i>Upload Photos — {{ event.title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="action" value="upload">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Photos <span class="text-danger">*</span></label>
                        <input type="file" name="images" id="photoInput" class="form-control" accept="image/*" multiple required>
                        <small class="text-muted">You can select multiple photos at once.</small>
                    </div>
                    <!-- Preview -->
                    <div id="previewContainer" class="row g-2 mt-1" style="display:none!important;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-cloud-upload me-1"></i> Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Lightbox Modal -->
<div class="modal fade" id="photoModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-dark border-0">
            <div class="modal-header border-0 pb-0">
                <p class="text-white-50 small mb-0" id="photoCaption"></p>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-2">
                <img id="lightboxImg" src="" alt="" class="img-fluid rounded" style="max-height:75vh;">
            </div>
        </div>
    </div>
</div>

<style>
.photo-card { border-radius: 8px; overflow: hidden; }
.photo-card img { transition: transform 0.2s ease; }
.photo-card:hover img { transform: scale(1.03); }
.delete-btn { opacity: 0; transition: opacity 0.2s; }
.photo-card:hover .delete-btn { opacity: 1; }
.photo-date-overlay {
    background: linear-gradient(transparent, rgba(0,0,0,0.55));
}
</style>

<script>
// Lightbox
document.querySelectorAll('[data-bs-target="#photoModal"]').forEach(img => {
    img.addEventListener('click', function () {
        document.getElementById('lightboxImg').src = this.dataset.src;
        document.getElementById('photoCaption').textContent = this.dataset.caption;
    });
});

// Image preview before upload
document.getElementById('photoInput').addEventListener('change', function () {
    const container = document.getElementById('previewContainer');
    container.innerHTML = '';
    if (this.files.length === 0) { container.style.display = 'none'; return; }
    container.style.display = 'flex';
    container.style.flexWrap = 'wrap';
    Array.from(this.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
            const col = document.createElement('div');
            col.className = 'col-4';
            col.innerHTML = `<img src="${e.target.result}" class="img-fluid rounded" style="height:80px;width:100%;object-fit:cover;">`;
            container.appendChild(col);
        };
        reader.readAsDataURL(file);
    });
});
</script>

{% endblock %}
